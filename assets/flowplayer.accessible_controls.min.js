// Flowplayer Accessible Controls - A plugin for Flowplayer
// This is part of ZAD Accessible Player - An extension for Contao CMS
// @package   zad_aplayer
// @author    Antonello Dessì
// @license   LGPL
// @copyright Antonello Dessì 2011-2013
$f.addPlugin("accessibleControls",function(id,options,fullscreenMode){var player=this,opts={captionsEnabled:true,fullscreenEnabled:true,buttonWidth:25,playLabel:"Play",pauseLabel:"Pause",volumeLabel:["Mute","Low","Medium","High"],captionsOnLabel:"Captions On",captionsOffLabel:"Captions Off",fullScreenLabel:"Full screen",normalScreenLabel:"Exit full screen",sliderHelp:"<strong>Left/Down:</strong> 10 seconds backward<br /><strong>Right/Up:</strong> 10 seconds forward<br /><strong>Page Down:</strong> 1 minute backward<br /><strong>Page Up:</strong> 1 minute forward<br /><strong>Home:</strong> clip begin<br /><strong>End:</strong> clip end",volumeHelp:"<strong>Left/Down:</strong> decrease volume<br /><strong>Right/Up:</strong> increase volume<br /><strong>Home:</strong> no sound<br /><strong>End:</strong> max volume"},template='<a class="play" href="javascript:;" title="" role="button"></a><div class="track"><div class="buffer"></div><div class="progress"></div><button class="playhead" title="" role="slider"></button></div><div class="time"></div><button class="volume" title="" role="slider"></button><a class="fullscreen" href="javascript:;" title="" role="button"></a><a class="captions" href="javascript:;" title="" role="button"></a><div class="help"></div>',play,track,buffer,progress,playhead,time,volume,fullscreen,captions,help,slider=Slider(),playerContainer=player.getParent(),playerWidth,timeWidth,trackWidth,timer=null,volumeSet=[0,40,80,100],volumeClass=["volumeMute","volumeLow","volumeMedium","volumeHigh"],volumeLevel=2,duration=0,key;function resize(){playerWidth=playerContainer.clientWidth;id.style.width=playerWidth+"px";timeWidth=(playerWidth>=400)?130:(playerWidth>=320)?100:0;if(timeWidth==0){time.style.display="none";time.style.width="0px"}else{time.style.display="block";time.style.width=timeWidth+"px";time.style.right=(opts.buttonWidth*(1+(opts.captionsEnabled?1:0)+(opts.fullscreenEnabled?1:0)))+"px"}trackWidth=playerWidth-timeWidth-10-opts.buttonWidth*(2+(opts.captionsEnabled?1:0)+(opts.fullscreenEnabled?1:0));track.style.width=trackWidth+"px";id.style.display="block";slider.init()}function byClass(name){var els=id.getElementsByTagName("*"),i=0;for(;i<els.length;i++){if(els[i].className==name){return els[i]}}}function toTime(sec){var h=Math.floor(sec/3600),min=Math.floor(sec/60);sec=Math.floor(sec-(min*60));if(h>=1){min-=h*60;return h+":"+((min>=10)?min:"0"+min)+":"+((sec>=10)?sec:"0"+sec)}return((min>=10)?min:"0"+min)+":"+((sec>=10)?sec:"0"+sec)}function getTime(tm,totaltm){return"<span>"+toTime(tm)+"</span> <strong>"+toTime(totaltm)+"</strong>"}function setVolumeLevel(level){volumeLevel=level;volume.className=volumeClass[volumeLevel];volume.title=opts.volumeLabel[volumeLevel];volume.setAttribute("aria-valuenow",volumeSet[volumeLevel]);volume.setAttribute("aria-valuetext",opts.volumeLabel[volumeLevel]);player.setVolume(volumeSet[volumeLevel])}function Slider(){var dragging,dragOffset,maxTime,maxBufferTime,maxX,offset,deltaX,deltaT,lastX;function init(){offset=Math.round(playhead.clientWidth/2);maxX=playhead.parentNode.clientWidth-playhead.clientWidth;maxBufferTime=0;setMaxTime(duration);dragging=false;dragOffset=0;lastX=-1;buffer.style.width="0px";progress.style.width="0px";playhead.style.left="0px";playhead.onkeydown=getKey;playhead.onmousedown=startDragging}function isDragging(){return dragging}function setMaxTime(val){maxTime=val;deltaX=maxTime/maxX;deltaT=(maxTime>0)?(maxX/maxTime):0}function setBufferTime(val){if(val>maxBufferTime){var x=Math.floor(val*deltaT);maxBufferTime=val;if(x>=maxX){x=maxX+playhead.clientWidth}else{if(x>0){x+=offset}}buffer.style.width=x+"px"}}function setProgressTime(val){var x=Math.floor(val*deltaT);progress.style.width=x+"px";playhead.style.left=x+"px";lastX=x}function goTo(e){var x,t;if(typeof e=="undefined"){e=window.event}if(e.target===playhead){return}if(typeof e.layerX=="undefined"){x=e.offsetX-offset}else{x=e.layerX-offset}if(x<0){x=0}else{if(x>maxX){x=maxX}}t=x*deltaX;if(maxBufferTime>0&&t<=maxBufferTime){player.seek((t==maxTime)?(t-0.1):t);progress.style.width=x+"px";playhead.style.left=x+"px";lastX=x}}function getKey(e){if(!player.isLoaded()){return true}var t=player.getTime();if(typeof e=="undefined"){e=window.event}switch(e.keyCode){case 37:case 40:t-=10;break;case 39:case 38:t+=10;break;case 33:t+=60;break;case 34:t-=60;break;case 36:t=0;break;case 35:t=maxTime-0.1;break;default:return true;break}if(t<0){t=0}else{if(t>=maxTime){t=maxTime-0.1}}setProgressTime(t);player.seek(t);return false}function startDragging(e){if(typeof e=="undefined"){e=window.event}dragging=true;dragOffset=e.clientX-lastX;document.onmousemove=drag;document.onmouseup=endDragging;return false}function drag(e){var x,t;if(typeof e=="undefined"){e=window.event}x=e.clientX-dragOffset;if(x<0){x=0}else{if(x>maxX){x=maxX}}t=x*deltaX;if(maxBufferTime>0&&t<=maxBufferTime){progress.style.width=x+"px";playhead.style.left=x+"px";lastX=x}return false}function endDragging(e){var t=lastX*deltaX;dragging=false;document.onmousemove=null;document.onmouseup=null;player.seek(t==maxTime?(t-0.1):t)}return{init:init,isDragging:isDragging,setMaxTime:setMaxTime,setBufferTime:setBufferTime,setProgressTime:setProgressTime,goTo:goTo}}if(typeof id!="string"||!(id=document.getElementById(id))){return}if(options){for(key in options){if(key){opts[key]=options[key]}}}id.innerHTML=template;play=byClass("play");time=byClass("time");track=byClass("track");buffer=byClass("buffer");progress=byClass("progress");playhead=byClass("playhead");volume=byClass("volume");fullscreen=byClass("fullscreen");captions=byClass("captions");help=byClass("help");time.innerHTML=getTime(0,duration);volume.style.right=(opts.buttonWidth*((opts.captionsEnabled?1:0)+(opts.fullscreenEnabled?1:0)))+"px";volume.setAttribute("aria-valuemin",0);volume.setAttribute("aria-valuemax",100);setVolumeLevel(volumeLevel);if(opts.fullscreenEnabled){fullscreen.style.right=(opts.buttonWidth*(opts.captionsEnabled?1:0))+"px";if(fullscreenMode.enable){fullscreen.className="normalscreen";fullscreen.title=opts.normalScreenLabel;fullscreen.label=opts.normalScreenLabel;window.onresize=fullscreenResize;document.onkeydown=fullscreenKeys}else{fullscreen.title=opts.fullScreenLabel;fullscreen.label=opts.fullScreenLabel}}else{fullscreen.style.display="none";fullscreen.style.width="0px"}if(opts.captionsEnabled){captions.title=opts.captionsOnLabel;captions.label=opts.captionsOnLabel}else{captions.style.display="none";captions.style.width="0px"}help.style.display="none";resize();play.onclick=function(){if(player.isLoaded()){player.toggle()}else{player.play()}};track.onclick=function(e){if(player.isLoaded()){slider.goTo(e)}};playhead.onfocus=function(){if(!fullscreenMode.enable){help.innerHTML=opts.sliderHelp;help.style.display="block"}};playhead.onblur=function(){help.style.display="none"};volume.onclick=function(){setVolumeLevel((volumeLevel+1)%4)};volume.onkeydown=function(e){if(typeof e=="undefined"){e=window.event}switch(e.keyCode){case 37:case 40:setVolumeLevel((volumeLevel-1<0)?0:(volumeLevel-1));break;case 39:case 38:setVolumeLevel((volumeLevel+1>3)?3:(volumeLevel+1));break;case 36:setVolumeLevel(0);break;case 35:setVolumeLevel(3);break;default:return true;break}return false};volume.onfocus=function(){if(!fullscreenMode.enable){help.innerHTML=opts.volumeHelp;help.style.display="block"}};volume.onblur=function(){help.style.display="none"};fullscreen.onclick=function(){var screenWidth,screenHeight,fullscreenWidth,fullscreenHeight,fullscreenLeft,fullscreenOverlay,fullscreenPlayer,fullscreenControls,body,cfg,fullscreenCfg;if(fullscreenMode.enable){window.onresize=null;document.onkeydown=null;fullscreenCfg={};fullscreenCfg.play=false;if(player.isPlaying()){player.pause();fullscreenCfg.play=true}fullscreenCfg.time=(player.getTime()>0)?player.getTime():0;body=document.getElementsByTagName("body")[0];fullscreenOverlay=document.getElementById("zad_aplayer_overlay_fullscreen");fullscreenPlayer=document.getElementById("zad_aplayer_fullscreen");fullscreenControls=document.getElementById("zad_aplayer_controls_fullscreen");body.removeChild(fullscreenOverlay);body.removeChild(fullscreenPlayer);body.removeChild(fullscreenControls);$f("*").each(function(){this.show()});if(!$f(fullscreenMode.index).isLoaded()){$f(fullscreenMode.index).load()}if(fullscreenCfg.play){$f(fullscreenMode.index).seek(fullscreenCfg.time-0.3);$f(fullscreenMode.index).play()}else{$f(fullscreenMode.index).seek(fullscreenCfg.time);$f(fullscreenMode.index).pause();$f(fullscreenMode.index).setPlayerTime(fullscreenCfg.time)}}else{fullscreenCfg={};fullscreenCfg.play=false;if(!player.isLoaded()){player.load()}else{if(player.isPlaying()){player.pause();fullscreenCfg.play=true}}fullscreenCfg.time=(player.getTime()>0)?(player.getTime()-0.2):0;fullscreenCfg.index=player.getIndex();fullscreenCfg.enable=true;cfg=player.getConfig(true);cfg.playerId="zad_aplayer_fullscreen";cfg.clip.autoPlay=false;if(window.innerHeight){screenHeight=window.innerHeight;screenWidth=window.innerWidth}else{screenHeight=document.body.clientHeight;screenWidth=document.body.clientWidth}fullscreenHeight=screenHeight-25;fullscreenWidth=Math.floor(playerWidth/playerContainer.clientHeight*fullscreenHeight);fullscreenLeft=Math.floor((screenWidth-fullscreenWidth)/2);fullscreenOverlay=document.createElement("div");fullscreenOverlay.id="zad_aplayer_overlay_fullscreen";fullscreenOverlay.className="zad_aplayer_overlay";fullscreenOverlay.style.position="fixed";fullscreenOverlay.style.zIndex=99;fullscreenOverlay.style.top="0px";fullscreenOverlay.style.left="0px";fullscreenOverlay.style.width=screenWidth+"px";fullscreenOverlay.style.height=screenHeight+"px";fullscreenOverlay.style.display="block";fullscreenPlayer=document.createElement("div");fullscreenPlayer.id="zad_aplayer_fullscreen";fullscreenPlayer.className="zad_aplayer";fullscreenPlayer.style.position="fixed";fullscreenPlayer.style.zIndex=100;fullscreenPlayer.style.top="0px";fullscreenPlayer.style.left=fullscreenLeft+"px";fullscreenPlayer.style.width=fullscreenWidth+"px";fullscreenPlayer.style.height=fullscreenHeight+"px";fullscreenPlayer.style.display="block";fullscreenControls=document.createElement("div");fullscreenControls.id="zad_aplayer_controls_fullscreen";fullscreenControls.className="zad_aplayer_controls";fullscreenControls.style.position="fixed";fullscreenControls.style.zIndex=100;fullscreenControls.style.bottom="0px";fullscreenControls.style.left=fullscreenLeft+"px";$f("*").each(function(){this.hide()});body=document.getElementsByTagName("body")[0];body.appendChild(fullscreenOverlay);body.appendChild(fullscreenPlayer);body.appendChild(fullscreenControls);$f(fullscreenPlayer,"system/modules/zad_aplayer/vendor/flowplayer/flowplayer-3.2.16.swf",cfg).accessibleControls("zad_aplayer_controls_fullscreen",options,fullscreenCfg)}};function fullscreenResize(e){var screenWidth,screenHeight,fullscreenWidth,fullscreenHeight,fullscreenLeft,fullscreenOverlay,fullscreenPlayer,fullscreenControls,body;if(window.innerHeight){screenHeight=window.innerHeight;screenWidth=window.innerWidth}else{screenHeight=document.body.clientHeight;screenWidth=document.body.clientWidth}fullscreenHeight=screenHeight-25;fullscreenWidth=Math.floor(playerWidth/playerContainer.clientHeight*fullscreenHeight);fullscreenLeft=Math.floor((screenWidth-fullscreenWidth)/2);body=document.getElementsByTagName("body")[0];fullscreenOverlay=document.getElementById("zad_aplayer_overlay_fullscreen");fullscreenPlayer=document.getElementById("zad_aplayer_fullscreen");fullscreenControls=document.getElementById("zad_aplayer_controls_fullscreen");fullscreenOverlay.style.width=screenWidth+"px";fullscreenOverlay.style.height=screenHeight+"px";fullscreenPlayer.style.left=fullscreenLeft+"px";fullscreenPlayer.style.width=fullscreenWidth+"px";fullscreenPlayer.style.height=fullscreenHeight+"px";fullscreenControls.style.left=fullscreenLeft+"px";resize()}function fullscreenKeys(e){if(typeof e=="undefined"){e=window.event}if(e.keyCode==27){fullscreen.onclick()}else{if(e.target===play||e.target===playhead||e.target===volume||e.target===fullscreen||e.target===captions||e.altKey||e.ctrlKey||e.metaKey){return true}else{if(e.keyCode==9){play.focus()}}}return false}captions.onclick=function(){if(captions.className=="captions"){captions.className="captionsOff";captions.title=opts.captionsOffLabel;captions.label=opts.captionsOffLabel;player.getPlugin("captionsContent").hide()}else{captions.className="captions";captions.title=opts.captionsOnLabel;captions.label=opts.captionsOnLabel;player.getPlugin("captionsContent").show()}};player.onUnload(function(){clearInterval(timer);time.innerHTML=getTime(0,duration)});player.onBegin(function(clip){play.className="pause";play.title=opts.pauseLabel;play.innerHTML=opts.pauseLabel});player.onFinish(function(clip){play.className="play";play.title=opts.playLabel;play.innerHTML=opts.playLabel;player.pause();player.seek(0);time.innerHTML=getTime(0,duration);slider.setProgressTime(0)});player.onStart(function(clip){var initial=true;duration=player.getClip().fullDuration||0;slider.setMaxTime(duration);clearInterval(timer);timer=setInterval(function(){var status;if(fullscreenMode.enable&&initial){initial=false;if(fullscreenMode.play){player.seek(fullscreenMode.time-0.3);player.play()}else{slider.setProgressTime(fullscreenMode.time);time.innerHTML=getTime(fullscreenMode.time,duration);player.seek(fullscreenMode.time);player.pause()}}status=player.getStatus();if(!status.time){status.time=player.getTime()}if(!status.bufferEnd){status.bufferEnd=status.time}if(!duration){duration=player.getClip().fullDuration||0;slider.setMaxTime(duration)}time.innerHTML=getTime(status.time,duration);slider.setBufferTime(status.bufferEnd);if(!player.isPaused()&&!slider.isDragging()){slider.setProgressTime(status.time)}playhead.setAttribute("aria-valuemin",0);playhead.setAttribute("aria-valuemax",Math.floor(status.bufferEnd));playhead.setAttribute("aria-valuenow",Math.floor(status.time));playhead.setAttribute("aria-valuetext",toTime(status.time))},500)});player.onPause(function(){play.className="play";play.title=opts.playLabel;play.innerHTML=opts.playLabel});player.onResume(function(){play.className="pause";play.title=opts.pauseLabel;play.innerHTML=opts.pauseLabel});player.onBeforeFullscreen(function(){return false});this.setPlayerTime=function(time){slider.setProgressTime(time)};return player});
